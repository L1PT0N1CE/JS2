// ==UserScript==
// @name         Better Sim-TT for RME
// @namespace    https://phonetool.amazon.com/users/kanataza
// @version      2.1
// @description  Combines Auto Refresher, Copy TT Link, WO Number & Open WO Link, and Correspondence Alt+3 Alt+4
// @author       Kanataza
// @match        https://t.corp.amazon.com/*
// @icon         https://media.licdn.com/dms/image/v2/D4E03AQEkSQG-ayth3g/profile-displayphoto-shrink_200_200/profile-displayphoto-shrink_200_200/0/1730057709648?e=2147483647&v=beta&t=C7VGPq9vEfeuAcJa6aO7eBLN8GDKcR5c70l1ABnA3DU
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_setClipboard
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // ==================== Auto Refresher ====================

    let refreshInterval = null;
    const savedSecondsKey = 'autoRefresherInterval';
    const savedPositionKey = 'countdownPosition';
    let savedSeconds = GM_getValue(savedSecondsKey, 0);
    let savedPosition = GM_getValue(savedPositionKey, { top: '10px', left: '50%' });
    let countdown = savedSeconds;

    const countdownDisplay = document.createElement('div');
    countdownDisplay.style.position = 'fixed';
    countdownDisplay.style.top = savedPosition.top;
    countdownDisplay.style.left = savedPosition.left;
    countdownDisplay.style.transform = 'translate(-50%, 0)';
    countdownDisplay.style.background = 'rgba(0, 0, 0, 0.7)';
    countdownDisplay.style.color = 'white';
    countdownDisplay.style.padding = '5px 10px';
    countdownDisplay.style.borderRadius = '5px';
    countdownDisplay.style.fontSize = '14px';
    countdownDisplay.style.zIndex = '9999';
    countdownDisplay.style.cursor = 'move';
    document.body.appendChild(countdownDisplay);

    function updateCountdownDisplay() {
        countdownDisplay.textContent = countdown > 0 ? `Refresh in: ${countdown}s` : '';
    }

    function startRefresher(seconds, showAlert = true) {
        if (refreshInterval) clearInterval(refreshInterval);

        if (seconds > 0) {
            countdown = seconds;
            updateCountdownDisplay();
            refreshInterval = setInterval(() => {
                countdown--;
                updateCountdownDisplay();
                if (countdown <= 0) location.reload();
            }, 1000);
            GM_setValue(savedSecondsKey, seconds);
            if (showAlert) alert(`Auto-Refresher aktiviert: ${seconds}s`);
        } else {
            countdownDisplay.textContent = '';
            alert('Auto-Refresher deaktiviert.');
        }
    }

    function handleRefresherInput() {
        const input = prompt(`Gib die Sekunden für den Auto-Refresher ein (0 zum Deaktivieren):`, savedSeconds > 0 ? savedSeconds.toString() : '180');
        const seconds = parseInt(input, 10);
        if (isNaN(seconds) || seconds < 0) return alert('Ungültige Eingabe.');

        if (seconds === 0) {
            clearInterval(refreshInterval);
            refreshInterval = null;
            GM_setValue(savedSecondsKey, 0);
            countdownDisplay.textContent = '';
            alert('Auto-Refresher deaktiviert.');
        } else {
            startRefresher(seconds);
        }
    }

    function makeDraggable(element) {
        let offsetX = 0, offsetY = 0, isDragging = false;
        element.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - element.getBoundingClientRect().left;
            offsetY = e.clientY - element.getBoundingClientRect().top;
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            element.style.left = `${e.clientX - offsetX}px`;
            element.style.top = `${e.clientY - offsetY}px`;
        });
        document.addEventListener('mouseup', () => {
            if (isDragging) GM_setValue(savedPositionKey, { top: element.style.top, left: element.style.left });
            isDragging = false;
        });
    }
    makeDraggable(countdownDisplay);

    if (savedSeconds > 0) startRefresher(savedSeconds, false);

    document.addEventListener('keydown', (event) => {
        if (event.altKey && event.key === '1') handleRefresherInput();
    });

    // ==================== Copy Buttons ====================

    function copyTitleAndURL() {
        const titleElem = document.querySelector('.title-container h1, .title-container span');
        const btn = document.getElementById('tcopybutton');
        if (!titleElem || !btn) return;
        const text = `${titleElem.innerText} (${document.URL})`;
        GM_setClipboard(text, 'text');
        btn.style.backgroundColor = 'yellow';
    }

    function getWorkOrderNumber() {
        const match = document.body.innerText.match(/(?:work order number:|EAM\(APM\) work order number:)\s*(\d+)/i);
        return match ? match[1] : null;
    }

    function copyWorkOrderNumber() {
        const wo = getWorkOrderNumber();
        const btn = document.getElementById('wocopybutton');
        if (!wo || !btn) return console.log('WO not found');
        GM_setClipboard(wo, 'text');
        btn.style.backgroundColor = 'yellow';
    }

    function openWorkOrderLink() {
        const wo = getWorkOrderNumber();
        if (!wo) return console.log('WO not found');
        const url = `https://eu1.eam.hxgnsmartcloud.com/web/base/logindisp?tenant=AMAZONRMEEU_PRD&FROMEMAIL=YES&SYSTEM_FUNCTION_NAME=WSJOBS&USER_FUNCTION_NAME=WSJOBS&workordernum=${wo}`;
        window.open(url, '_blank');
    }

    function insertButtons(editIssueElem) {
        if (document.getElementById('tcopybutton')) return;

        const wrapper = document.createElement('div');
        wrapper.style.display = 'inline-flex';
        wrapper.style.gap = '5px';
        wrapper.style.marginRight = '8px';

        const makeBtn = (id, text, handler) => {
            const btn = document.createElement('button');
            btn.id = id;
            btn.textContent = text;
            btn.className = 'awsui-button awsui-button-variant-normal awsui-hover-child-icons';
            btn.addEventListener('click', handler);
            return btn;
        };

        wrapper.appendChild(makeBtn('tcopybutton', 'Copy Title & URL', copyTitleAndURL));
        wrapper.appendChild(makeBtn('wocopybutton', 'Copy Work Order', copyWorkOrderNumber));
        wrapper.appendChild(makeBtn('wolinkbutton', 'Open WO Link', openWorkOrderLink));

        editIssueElem.parentNode.insertBefore(wrapper, editIssueElem);
    }

    const observer = new MutationObserver(() => {
        const editButton = Array.from(document.querySelectorAll('button')).find(b => b.textContent.trim() === 'Edit');
        if (editButton) {
            const editIssueElem = editButton.closest('.edit-issue');
            if (editIssueElem) insertButtons(editIssueElem);
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // ==================== Correspondence Alt+3/Alt+4 ====================

    function fillAndSubmitResponse(responseText) {
        var commentTextarea = $('#sim-communicationActions--createComment');
        commentTextarea.focus();
        document.execCommand('insertText', false, responseText);
        $('.sim-communicationActions--addCommentButton').click();
    }

    // ==================== FIXED KEYWORD LOGIC ====================

    function getResponseTextFromTitle(title) {
        title = title.toLowerCase();

        // Racklight / Rack
        if (/\bracklight\b|\brack\b/.test(title))
            return "We restarted the Racklight/Rack. The Station is operational again.\nBest regards.";

        // Lifter
        if (/\blifter\b/.test(title))
            return "We restarted the lifter. The Station is operational again.\nBest regards.";

        // Aether / no comms
        if (/\baether\b|\bno comms\b/.test(title))
            return "Aether on Floor2 is still not Activ in FRA7 yet because of Missing KNX Connection.\nBest regards.";

        // Destacker / Desticker / etc.
        if (/\bdestacker\b|\bdestucker\b|\bdesticker\b|\bdestaker\b|\bdasticker\b/.test(title))
            return "We restarted the Stacker. The Station is operational again.\nBest regards.";

        // Fiducial
        if (/\bfiducial\b/.test(title))
            return "We replaced the Fiducial. The Floor is operational again.\nBest regards.";

        // IDS
        if (/\bids\b/.test(title))
            return "We restarted the IDS. The Station is operational again.\nBest regards.";

        // Outbound conveyor
        if (/\boutbound\b|\bconvey(or|er)\b|\bhigh control\b/.test(title))
            return "We removed the Jam. The Conveyor is operational again.\nBest regards.";

        // POD / Bin  (FIX: keine Treffer mehr in „Verbindung“)
        if (/\bpod\b|\bbin\b/.test(title))
            return "We cleaned the POD. The POD is operational again.\nBest regards.";

        // Screen / Monitor reboot
        if (/\bbildschirm\b|\bscreen\b|\brestart\b|\bneustart\b|\breboot\b|\bverbindung\b|\bmonitor\b|\bcomputer\b|\breset\b/.test(title))
            return "We restarted the System. The Station is operational again.\nBest regards.";

        // Liquid / Spill
        if (/\bliquid\b|\bausgelaufen\b|\bspill\b/.test(title))
            return "We cleaned the Area/Floor. The Area/Floor is operational again.\nBest regards.";

        // Fido alarm
        if (/\bfido\b|\balarm\b/.test(title))
            return "We fixed the Fido. The Station is operational again.\nBest regards.";

        // E-Stop
        if (/\bestop\b|\be-stop\b|\bfloor stopped\b/.test(title))
            return "We removed the E-Stop. The Floor is operational again.\nBest regards.";

        // Low confidence
        if (/\blow confidence\b/.test(title))
            return "We checked, cleaned and aligned the Cameras. The Stations are operational again.\nBest regards.";

        // Depal
        if (/\bdepal\b/.test(title))
            return "We fixed the Jam/Crash on the Depal. The Depaletizer is operational again.\nBest regards.";

        // Drive / DU
        if (/\bdrive\b|\bdu\b/.test(title))
            return "We fixed the Drive. The Drive operational again.\nBest regards.";

        // Default
        return "The Station, Drive, Charger, Floor, Pod, Conveyance, Area, is operational again.\nBest regards.";
    }

    $(document).keydown(function(event) {
        if (event.altKey && event.keyCode === 51) {
            fillAndSubmitResponse("Hello, \nthe RME team has received your ticket and will process your request as soon as possible. \nBest regards.");
        } else if (event.altKey && event.keyCode === 52) {
            var titleText = $('#sim-title').text();
            fillAndSubmitResponse(getResponseTextFromTitle(titleText));
        }
    });

})();
